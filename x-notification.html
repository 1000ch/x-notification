<script>
'use strict';

if (!document.registerElement) {
  throw new Error('Browser does not support document.registerElement');
}

window.XNotification = (function () {

  var noop = function noop() {};
  var STRING_ATTRS = ['title', 'dir', 'lang', 'tag', 'icon'];
  var NUMBER_ATTRS = ['delay', 'timeout'];
  var BOOLEAN_ATTRS = ['autoshow'];
  var FUNCTION_ATTRS = ['onclick', 'onshow', 'onerror', 'onclose'];

  // fix Notification object
  var Notification = window.Notification || window.webkitNotification || window.mozNotification;
  var XNotificationPrototype = Object.create(HTMLUnknownElement.prototype);

  // Check the permission for browser notification
  XNotificationPrototype.createdCallback = function () {

    // if Notification.permission is not 'granted'
    // request permission to show notification
    if (Notification.permission !== 'granted') {
      Notification.requestPermission(function (status) {
        if (Notification.permission !== status) {
          Notification.permission = status;
        }
      });
    }
  };

  // When x-notification or XNotification object it set,
  // prepare parameters for Notification object
  XNotificationPrototype.attachedCallback = function () {

    this.options = {
      title: this.getAttribute('title'),
      dir: this.getAttribute('dir'),
      lang: this.getAttribute('lang'),
      body: this.textContent,
      tag: this.getAttribute('tag'),
      icon: this.getAttribute('icon')
    };

    if (['auto', 'ltr', 'rtl'].indexOf(this.options.dir) === -1) {
      this.options.dir = 'auto';
    }

    this.delay = Number(this.getAttribute('delay')) || 0;
    this.timeout = Number(this.getAttribute('timeout')) || 0;
    this.autoshow = this.hasAttribute('autoshow');
  
    this.onclick = this.getAttribute('onclick') ? new Function(this.getAttribute('onclick')) : noop;
    this.onshow = this.getAttribute('onshow') ? new Function(this.getAttribute('onshow')) : noop;
    this.onerror = this.getAttribute('onerror') ? new Function(this.getAttribute('onerror')) : noop;
    this.onclose = this.getAttribute('onclose') ? new Function(this.getAttribute('onclose')) : noop;
  
    if (this.autoshow) {
      this.show();
    }
  };

  XNotificationPrototype.detachedCallback = function () {
    if (this.notification) {
      this.notification.close();
    }
  };

  // If attribute is changed
  XNotificationPrototype.attributeChangedCallback = function (attributeName, oldValue, newValue) {
    if (STRING_ATTRS.indexOf(attributeName)) {
      this.options[attributeName] = newValue;
      if (['auto', 'ltr', 'rtl'].indexOf(this.options.dir) === -1) {
        this.options.dir = 'auto';
      }
    } else if (NUMBER_ATTRS.indexOf(attributeName)) {
      this[attributeName] = Number(newValue) || 0;
    } else if (BOOLEAN_ATTRS.indexOf(attributeName)) {
      this[attributeName] = this.hasAttribute(attributeName);
    } else if (FUNCTION_ATTRS.indexOf(attributeName)) {
      this[attributeName] = newValue ? new Function(newValue) : noop; 
    }
  };

  // Show notification
  XNotificationPrototype.show = function () {
    var that = this;
    this.delayTimerId = setTimeout(function () {
      that.notification = new Notification(that.options.title, that.options);
      that.notification.onclick = that.onclick;
      that.notification.onshow = that.onshow;
      that.notification.onerror = that.onerror;
      that.notification.onclose = that.onclose;
      if (that.timeout !== 0) {
        that.timeoutTimerId = window.setTimeout(function () {
          that.close();
        }, that.timeout);
      }
    }, that.delay);
  };

  // Close notification
  XNotificationPrototype.close = function () {
    if (this.notification) {
      this.notification.close();
    }
    this.disposeTimer();
  };

  // Stop timers for delay and timeout
  XNotificationPrototype.disposeTimer = function () {
    if (this.delayTimerId) {
      window.clearTimeout(this.delayTimerId);
    }
    if (this.timeoutTimerId) {
      window.clearTimeout(this.timeoutTimerId);
    }
  };

  return document.registerElement('x-notification', {
    prototype: XNotificationPrototype
  });
})();
</script>